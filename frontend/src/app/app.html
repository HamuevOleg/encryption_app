<div class="app-container">
  <header class="app-header">
    <div class="brand">
      <h1>{{ title() }}</h1>
      <p>Secure encryption using AES, RSA & ECC protocols</p>
    </div>
    <button class="secondary" (click)="openKeyModal()">
      <span class="icon">?</span> What is a key?
    </button>
  </header>

  <main class="app-main">
    <section class="sidebar">
      <section class="algorithms">
        <h3>Select Protocol</h3>
        <div class="cards">
          @for (alg of algorithms(); track alg.id) {
            <div class="card" [class.active]="alg.id === selectedMethod()" (click)="setMethod(alg.id)">
              <div class="card-header">
                <h3>{{ alg.name }}</h3>
                <span class="badge">{{ alg.id }}</span>
              </div>
              <p class="short">{{ alg.short }}</p>
              <div class="card-actions">
                <button class="ghost" (click)="openAlgorithmModal(alg); $event.stopPropagation()">View Details â†’</button>
              </div>
            </div>
          }
        </div>
      </section>
    </section>

    <section class="panel">
      <div class="panel-header">
        <div *ngIf="selectedAlgorithm() as alg">
          <h2>{{ alg.name }} Operations</h2>
          <p class="panel-subtitle">Interactive Visualization & IO</p>
        </div>
      </div>

      <div class="keys-section-top">
        <div class="section-title"><h3>Security Keys</h3></div>

        <div *ngIf="selectedMethod() === 'AES'" class="key-row-horizontal">
          <div class="key-input-wrapper">
            <label>AES Secret Key (Base64)</label>
            <div class="input-with-button">
              <textarea [ngModel]="aesKey()" (ngModelChange)="aesKey.set($event)" placeholder="Generate or paste key..." rows="2" spellcheck="false"></textarea>
              <button class="generate-btn" (click)="onGenerateAesKey()">Generate</button>
            </div>
          </div>
        </div>

        <div *ngIf="selectedMethod() === 'RSA'" class="key-row-grid">
          <div class="key-input-wrapper">
            <label>RSA Public Key</label>
            <textarea [ngModel]="rsaPublicKey()" (ngModelChange)="rsaPublicKey.set($event)" placeholder="-----BEGIN PUBLIC KEY-----" rows="3" spellcheck="false"></textarea>
          </div>
          <div class="key-input-wrapper">
            <label>RSA Private Key</label>
            <textarea [ngModel]="rsaPrivateKey()" (ngModelChange)="rsaPrivateKey.set($event)" placeholder="-----BEGIN PRIVATE KEY-----" rows="3" spellcheck="false"></textarea>
          </div>
          <button class="generate-btn-full" (click)="onGenerateRsaKeys()">Generate RSA Keys</button>
        </div>

        <div *ngIf="selectedMethod() === 'ECC'" class="key-row-grid">
          <div class="key-input-wrapper">
            <label>ECC Public Key</label>
            <textarea [ngModel]="eccPublicKey()" (ngModelChange)="eccPublicKey.set($event)" placeholder="Hex string..." rows="2" spellcheck="false"></textarea>
          </div>
          <div class="key-input-wrapper">
            <label>ECC Private Key</label>
            <textarea [ngModel]="eccPrivateKey()" (ngModelChange)="eccPrivateKey.set($event)" placeholder="Hex string..." rows="2" spellcheck="false"></textarea>
          </div>
          <button class="generate-btn-full" (click)="onGenerateEccKeys()">Generate ECC Keys</button>
        </div>
      </div>

      <div class="visualizer-section" [class.active]="isVisualizing() || encryptedText()">
        <div class="section-title"><h3>Encryption Logic Flow</h3></div>
        <div class="flow-diagram">
          <div class="diagram-container aes-flow" *ngIf="selectedMethod() === 'AES'">
            <div class="node input">Data Block</div><div class="arrow">â†“</div>
            <div class="node step" [class.pulse]="isLoading()">SubBytes<br><span class="small">S-Box</span></div><div class="arrow">â†“</div>
            <div class="node step" [class.pulse]="isLoading()">ShiftRows<br><span class="small">Permutation</span></div><div class="arrow">â†“</div>
            <div class="node step" [class.pulse]="isLoading()">MixColumns<br><span class="small">Matrix Mult.</span></div><div class="arrow">â†“</div>
            <div class="node output">Cipher Block</div>
          </div>
          <div class="diagram-container rsa-flow" *ngIf="selectedMethod() === 'RSA'">
            <div class="math-block"><span class="label">Encryption</span><div class="formula" [class.glow]="isLoading() && lastOperation() === 'encrypt'">C = M<sup>e</sup> <span class="op">mod</span> n</div></div>
            <div class="divider"></div>
            <div class="math-block"><span class="label">Decryption</span><div class="formula" [class.glow]="isLoading() && lastOperation() === 'decrypt'">M = C<sup>d</sup> <span class="op">mod</span> n</div></div>
          </div>
          <div class="diagram-container ecc-flow" *ngIf="selectedMethod() === 'ECC'">
            <div class="curve-viz">
              <svg viewBox="0 0 100 100" class="curve-svg">
                <path d="M10,50 Q30,10 50,50 T90,50" fill="none" stroke="var(--primary)" stroke-width="2" />
                <circle cx="30" cy="30" r="3" fill="var(--secondary)" class="point p" [class.moving]="isLoading()"/>
              </svg>
              <div class="caption">yÂ² = xÂ³ + ax + b</div>
            </div>
          </div>
        </div>

        <div class="bit-stream-container">
          <div class="bit-row"><label>Input Bits</label><div class="bits">{{ plainBits() || 'Waiting for input...' }}</div></div>
          <div class="process-line" [class.active]="isLoading()"></div>
          <div class="bit-row"><label>Output Bits</label><div class="bits cipher">{{ cipherBits() || 'Waiting for result...' }}</div></div>
        </div>
      </div>

      <div class="io-section">
        <div class="io-grid">

          <div class="io-column input-column">
            <label>Plain Text / Input</label>
            <div class="input-wrapper-relative">
              <textarea [ngModel]="plaintext()" (ngModelChange)="plaintext.set($event)" placeholder="Enter text here..." rows="8"></textarea>

              <button *ngIf="showDecryptCopy()" class="copy-btn-floating" (click)="copyResult()">
                <span class="icon">ðŸ“‹</span> {{ copyButtonLabel() }}
              </button>
            </div>
          </div>

          <div class="io-column output-column">
            <label>Cipher Text / Result</label>
            <div class="input-wrapper-relative">
              <textarea [ngModel]="encryptedText()" (ngModelChange)="encryptedText.set($event)" placeholder="Result will appear here..." rows="8" readonly></textarea>

              <button *ngIf="showEncryptCopy()" class="copy-btn-floating" (click)="copyResult()">
                <span class="icon">ðŸ“‹</span> {{ copyButtonLabel() }}
              </button>
            </div>
          </div>

        </div>
      </div>

      <div class="actions">
        <button class="primary" (click)="onEncrypt()" [disabled]="isLoading()">{{ isLoading() && lastOperation() === 'encrypt' ? 'Encrypting...' : 'Encrypt' }}</button>
        <button class="outline" (click)="onDecrypt()" [disabled]="isLoading()">{{ isLoading() && lastOperation() === 'decrypt' ? 'Decrypting...' : 'Decrypt' }}</button>
      </div>

      <div class="messages">
        <div class="error" *ngIf="errorMessage()">{{ errorMessage() }}</div>
        <div class="info" *ngIf="infoMessage()">{{ infoMessage() }}</div>
        <div class="meta" *ngIf="lastExecutionTimeMs() !== null"><span>Process Time: {{ lastExecutionTimeMs() }}ms</span></div>
      </div>
    </section>
  </main>

  <div class="modal-backdrop" *ngIf="showAlgorithmModal()" (click)="closeAlgorithmModal()"><div class="modal" (click)="$event.stopPropagation()"><header><h2>{{ activeAlgorithmInfo()?.name }}</h2><button class="icon" (click)="closeAlgorithmModal()">âœ•</button></header><section><p>{{ activeAlgorithmInfo()?.description }}</p></section></div></div>
  <div class="modal-backdrop" *ngIf="showKeyModal()" (click)="closeKeyModal()"><div class="modal" (click)="$event.stopPropagation()"><header><h2>Key Info</h2><button class="icon" (click)="closeKeyModal()">âœ•</button></header><section><p>Keys are fundamental for cryptography...</p></section></div></div>
</div>
