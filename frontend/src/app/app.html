<div class="app-container">
  <header class="app-header">
    <div class="header-left">
      <button class="history-toggle-btn" (click)="toggleHistory()">ğŸ•’</button>
      <div class="brand">
        <h1>{{ title() }}</h1>
        <p>Secure Encryption Playground</p>
      </div>
    </div>
    <button class="secondary" (click)="openKeyModal()">
      <span class="icon">?</span> What is a key?
    </button>
  </header>

  <aside class="history-drawer" [class.open]="showHistoryDrawer()">
    <div class="drawer-header">
      <h3>History (Local)</h3>
      <button class="close-drawer" (click)="toggleHistory()">âœ•</button>
    </div>
    <div class="drawer-content">
      <div class="history-warning">âš ï¸ Saved in browser only.</div>
      <button class="clear-btn" (click)="clearHistory()" *ngIf="history().length">Clear All</button>
      <div class="history-list">
        @for (item of history(); track item.id) {
          <div class="history-item" (click)="openHistoryDetail(item)">
            <div class="item-header">
              <span class="method-badge">{{ item.method }}</span>
              <span class="op-badge" [class.enc]="item.operation === 'encrypt'">{{ item.operation === 'encrypt' ? 'ENC' : 'DEC' }}</span>
            </div>
            <span class="timestamp">{{ formatDate(item.timestamp) }}</span>
          </div>
        }
        <div class="empty-history" *ngIf="!history().length">Empty history</div>
      </div>
    </div>
  </aside>
  <div class="drawer-backdrop" *ngIf="showHistoryDrawer()" (click)="toggleHistory()"></div>

  <main class="app-main">
    <section class="sidebar">
      <section class="algorithms">
        <h3>Algorithm</h3>
        <div class="cards">
          @for (alg of algorithms(); track alg.id) {
            <div class="card" [class.active]="alg.id === selectedMethod()" (click)="setMethod(alg.id)">
              <div class="card-header">
                <h3>{{ alg.name }}</h3>
                <span class="badge">{{ alg.id }}</span>
              </div>
              <p class="short">{{ alg.short }}</p>
              <div class="card-actions">
                <button class="ghost" (click)="openAlgorithmModal(alg); $event.stopPropagation()">Learn more â†’</button>
              </div>
            </div>
          }
        </div>
      </section>
    </section>

    <section class="panel">
      <div class="panel-header">
        <div *ngIf="selectedAlgorithm() as alg">
          <h2>{{ alg.name }} Operations</h2>
          <p class="panel-subtitle">Interactive Visualization</p>
        </div>
      </div>

      <div class="keys-section-top">
        <div class="section-title"><h3>Configuration & Keys</h3></div>

        <div *ngIf="selectedMethod() === 'AES'" class="key-row-horizontal">
          <div class="key-options">
            <label>Key Size</label>
            <div class="segmented-control">
              <button [class.active]="aesKeySize() === 128" (click)="setAesSize(128)">128</button>
              <button [class.active]="aesKeySize() === 192" (click)="setAesSize(192)">192</button>
              <button [class.active]="aesKeySize() === 256" (click)="setAesSize(256)">256</button>
            </div>
          </div>
          <div class="key-input-wrapper">
            <label>Secret Key</label>
            <div class="input-with-button">
              <textarea [ngModel]="aesKey()" (ngModelChange)="aesKey.set($event)" placeholder="Paste or Generate Key..." class="compact-textarea" rows="1" spellcheck="false"></textarea>

              <div class="key-actions">
                <button class="icon-btn" title="Import" (click)="triggerImport('aesFile')">ğŸ“‚</button>
                <button class="icon-btn" title="Export" (click)="downloadFile(aesKey(), 'aes.key')">ğŸ’¾</button>
                <button class="generate-btn" (click)="onGenerateAesKey()">Generate</button>
                <input type="file" id="aesFile" hidden (change)="onFileSelected($event, 'aes')">
              </div>
            </div>
          </div>
        </div>

        <div *ngIf="selectedMethod() === 'RSA'" class="key-row-grid">
          <div class="key-input-wrapper">
            <div class="label-row"><label>Public Key</label>
              <div class="mini-actions"><button class="mini-btn" (click)="triggerImport('rsaPub')">ğŸ“‚</button><button class="mini-btn" (click)="downloadFile(rsaPublicKey(), 'pub.pem')">ğŸ’¾</button></div></div>
            <textarea [ngModel]="rsaPublicKey()" (ngModelChange)="rsaPublicKey.set($event)" placeholder="-----BEGIN PUBLIC KEY-----" rows="3"></textarea>
            <input type="file" id="rsaPub" hidden (change)="onFileSelected($event, 'rsa-pub')">
          </div>
          <div class="key-input-wrapper">
            <div class="label-row"><label>Private Key</label>
              <div class="mini-actions"><button class="mini-btn" (click)="triggerImport('rsaPriv')">ğŸ“‚</button><button class="mini-btn" (click)="downloadFile(rsaPrivateKey(), 'priv.pem')">ğŸ’¾</button></div></div>
            <textarea [ngModel]="rsaPrivateKey()" (ngModelChange)="rsaPrivateKey.set($event)" placeholder="-----BEGIN PRIVATE KEY-----" rows="3"></textarea>
            <input type="file" id="rsaPriv" hidden (change)="onFileSelected($event, 'rsa-priv')">
          </div>
          <button class="generate-btn-full" (click)="onGenerateRsaKeys()">Generate RSA Pair</button>
        </div>

        <div *ngIf="selectedMethod() === 'ECC'" class="key-row-grid">
          <div class="key-input-wrapper">
            <div class="label-row"><label>Public Key</label>
              <div class="mini-actions"><button class="mini-btn" (click)="triggerImport('eccPub')">ğŸ“‚</button><button class="mini-btn" (click)="downloadFile(eccPublicKey(), 'ecc_pub.hex')">ğŸ’¾</button></div></div>
            <textarea [ngModel]="eccPublicKey()" (ngModelChange)="eccPublicKey.set($event)" placeholder="Hex..." rows="2"></textarea>
            <input type="file" id="eccPub" hidden (change)="onFileSelected($event, 'ecc-pub')">
          </div>
          <div class="key-input-wrapper">
            <div class="label-row"><label>Private Key</label>
              <div class="mini-actions"><button class="mini-btn" (click)="triggerImport('eccPriv')">ğŸ“‚</button><button class="mini-btn" (click)="downloadFile(eccPrivateKey(), 'ecc_priv.hex')">ğŸ’¾</button></div></div>
            <textarea [ngModel]="eccPrivateKey()" (ngModelChange)="eccPrivateKey.set($event)" placeholder="Hex..." rows="2"></textarea>
            <input type="file" id="eccPriv" hidden (change)="onFileSelected($event, 'ecc-priv')">
          </div>
          <button class="generate-btn-full" (click)="onGenerateEccKeys()">Generate ECC Pair</button>
        </div>
      </div>

      <div class="visualizer-section" [class.active]="isVisualizing() || encryptedText()">
        <div class="section-title"><h3>Encryption Logic Flow</h3></div>

        <div class="flow-diagram">
          <div class="diagram-container aes-flow" *ngIf="selectedMethod() === 'AES'">
            <div class="node input">Data Block</div>
            <div class="arrow">â†“</div>
            <div class="node step" [class.pulse]="isLoading()">SubBytes<br><span class="small">S-Box</span></div>
            <div class="arrow">â†“</div>
            <div class="node step" [class.pulse]="isLoading()">ShiftRows<br><span class="small">Permute</span></div>
            <div class="arrow">â†“</div>
            <div class="node step" [class.pulse]="isLoading()">MixColumns<br><span class="small">Matrix</span></div>
            <div class="arrow">â†“</div>
            <div class="node output">Cipher</div>
          </div>

          <div class="diagram-container rsa-flow" *ngIf="selectedMethod() === 'RSA'">
            <div class="math-block">
              <span class="label">Encryption Formula</span>
              <div class="formula" [class.glow]="isLoading()">
                C = M<sup>e</sup> <span class="op">mod</span> n
              </div>
            </div>
          </div>

          <div class="diagram-container ecc-flow" *ngIf="selectedMethod() === 'ECC'">
            <div class="curve-viz">
              <svg viewBox="0 0 100 100" class="curve-svg">
                <path d="M10,90 Q30,10 50,50 T90,10" fill="none" stroke="var(--primary)" stroke-width="2" />
                <circle cx="10" cy="90" r="4" fill="var(--secondary)" class="point" [class.moving]="isLoading()"/>
              </svg>
              <div class="caption">yÂ² = xÂ³ + ax + b</div>
            </div>
          </div>
        </div>

        <div class="bit-stream-container">
          <div class="bit-row"><label>Input Bits</label><div class="bits">{{ plainBits() || 'Waiting...' }}</div></div>
          <div class="process-line" [class.active]="isLoading()"></div>
          <div class="bit-row"><label>Output Bits</label><div class="bits cipher">{{ cipherBits() || 'Waiting...' }}</div></div>
        </div>
      </div>

      <div class="io-section">
        <div class="io-grid">
          <div class="io-column input-column">
            <label>Input</label>
            <div class="input-wrapper-relative">
              <textarea [ngModel]="plaintext()" (ngModelChange)="plaintext.set($event)" placeholder="Type here..." rows="6"></textarea>
              <button *ngIf="showDecryptCopy()" class="copy-btn-floating" (click)="copyResult()">ğŸ“‹ {{ copyButtonLabel() }}</button>
            </div>
          </div>
          <div class="io-column output-column">
            <label>Output</label>
            <div class="input-wrapper-relative">
              <textarea [ngModel]="encryptedText()" (ngModelChange)="encryptedText.set($event)" placeholder="Result..." rows="6" readonly></textarea>
              <button *ngIf="showEncryptCopy()" class="copy-btn-floating" (click)="copyResult()">ğŸ“‹ {{ copyButtonLabel() }}</button>
            </div>
          </div>
        </div>
      </div>

      <div class="actions">
        <button class="primary" (click)="onEncrypt()" [disabled]="isLoading()">{{ isLoading() && lastOperation() === 'encrypt' ? 'Encrypting...' : 'Encrypt' }}</button>
        <button class="outline" (click)="onDecrypt()" [disabled]="isLoading()">{{ isLoading() && lastOperation() === 'decrypt' ? 'Decrypting...' : 'Decrypt' }}</button>
      </div>
      <div class="messages"><div class="error" *ngIf="errorMessage()">{{ errorMessage() }}</div><div class="info" *ngIf="infoMessage()">{{ infoMessage() }}</div></div>
    </section>
  </main>

  <div class="modal-backdrop" *ngIf="selectedHistoryItem()" (click)="closeHistoryDetail()"><div class="modal" (click)="$event.stopPropagation()"><header><h2>Operation Detail</h2><button class="icon" (click)="closeHistoryDetail()">âœ•</button></header><section class="history-detail-content" *ngIf="selectedHistoryItem() as item"><div class="detail-row"><span class="label">Method:</span><span class="val">{{item.method}}</span></div><div class="detail-block"><label>Key</label><div class="code-block">{{item.keyUsed}}</div></div><div class="detail-block"><label>Output</label><div class="code-block highlight">{{item.output}}</div></div></section></div></div>

  <div class="modal-backdrop" *ngIf="showAlgorithmModal()" (click)="closeAlgorithmModal()"><div class="modal" (click)="$event.stopPropagation()"><header><h2>{{ activeAlgorithmInfo()?.name }}</h2><button class="icon" (click)="closeAlgorithmModal()">âœ•</button></header><section><p>{{ activeAlgorithmInfo()?.description }}</p><h3>How it works</h3><p>{{ activeAlgorithmInfo()?.howItWorks }}</p><ul><li *ngFor="let p of activeAlgorithmInfo()?.pros">âœ… {{p}}</li></ul><ul><li *ngFor="let c of activeAlgorithmInfo()?.cons">âŒ {{c}}</li></ul></section></div></div>

  <div class="modal-backdrop" *ngIf="showKeyModal()" (click)="closeKeyModal()"><div class="modal" (click)="$event.stopPropagation()"><header><h2>{{ keyExplanation.title }}</h2><button class="icon" (click)="closeKeyModal()">âœ•</button></header><section><p *ngFor="let p of keyExplanation.paragraphs">{{ p }}</p></section></div></div>
</div>
